
/* 
 * Copyright (C) 2025 Alaa-eddine KADDOURI
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import*as D from"echarts";var pt=Object.defineProperty,ut=(a,e,t)=>e in a?pt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,q=(a,e,t)=>(ut(a,typeof e!="symbol"?e+"":e,t),t);class gt{constructor(e,t,i,s={}){q(this,"id"),q(this,"plots"),q(this,"paneIndex"),q(this,"height"),q(this,"collapsed"),q(this,"titleColor"),q(this,"controls"),this.id=e,this.plots=t,this.paneIndex=i,this.height=s.height,this.collapsed=s.collapsed||!1,this.titleColor=s.titleColor,this.controls=s.controls}toggleCollapse(){this.collapsed=!this.collapsed}isVisible(){return!this.collapsed}updateData(e){Object.keys(e).forEach(t=>{if(!this.plots[t])this.plots[t]=e[t];else{const i=this.plots[t],s=e[t];s.options&&(i.options={...i.options,...s.options});const n=new Map;i.data.forEach(o=>{n.set(o.time,o)}),s.data.forEach(o=>{n.set(o.time,o)}),i.data=Array.from(n.values()).sort((o,h)=>o.time-h.time)}})}}class ct{static calculate(e,t,i,s=!1,n=null){let o=0;e>0&&(o=1/e*100);const h=Array.from(t.values()).map(m=>m.paneIndex).filter(m=>m>0).sort((m,k)=>m-k).filter((m,k,z)=>z.indexOf(m)===k),p=h.length>0,d=i.dataZoom?.visible??!0,b=i.dataZoom?.position??"top",u=i.dataZoom?.height??6,l=i.dataZoom?.start??0,v=i.dataZoom?.end??100;let g=8,P=92,S=-1;if(n)if(n==="main")S=0;else{const m=t.get(n);m&&(S=m.paneIndex)}if(S!==-1){const m=[],k=[],z=[],O=[],N=i.dataZoom?.start??50,w=i.dataZoom?.end??100;O.push({type:"inside",xAxisIndex:"all",start:N,end:w});const E=p?Math.max(...h):0,Y=[];for(let F=0;F<=E;F++){const T=F===S;if(m.push({left:"10%",right:"10%",top:T?"5%":"0%",height:T?"90%":"0%",show:T,containLabel:!1}),k.push({type:"category",gridIndex:F,data:[],show:T,axisLabel:{show:T,color:"#94a3b8",fontFamily:i.fontFamily},axisLine:{show:T,lineStyle:{color:"#334155"}},splitLine:{show:T,lineStyle:{color:"#334155",opacity:.5}}}),z.push({position:"right",gridIndex:F,show:T,scale:!0,axisLabel:{show:T,color:"#94a3b8",fontFamily:i.fontFamily},splitLine:{show:T,lineStyle:{color:"#334155",opacity:.5}}}),F>0){const W=Array.from(t.values()).find(B=>B.paneIndex===F);W&&Y.push({index:F,height:T?90:0,top:T?5:0,isCollapsed:!1,indicatorId:W.id,titleColor:W.titleColor,controls:W.controls})}}return{grid:m,xAxis:k,yAxis:z,dataZoom:O,paneLayout:Y,mainPaneHeight:S===0?90:0,mainPaneTop:S===0?5:0,pixelToPercent:o}}d?b==="top"?(g=u+4,P=95):(P=100-u-2,g=8):(g=5,P=95);let f=5;e>0&&(f=20/e*100);let r=75,c=[];if(p){const m=h.map(w=>{const E=Array.from(t.values()).find(Y=>Y.paneIndex===w);return{index:w,requestedHeight:E?.height,isCollapsed:E?.collapsed??!1,indicatorId:E?.id,titleColor:E?.titleColor,controls:E?.controls}}).map(w=>({...w,height:w.isCollapsed?3:w.requestedHeight!==void 0?w.requestedHeight:15})),k=m.reduce((w,E)=>w+E.height,0),z=m.length*f,O=k+z;r=P-g-O,s?r=3:r<20&&(r=Math.max(r,10));let N=g+r+f;c=m.map(w=>{const E={index:w.index,height:w.height,top:N,isCollapsed:w.isCollapsed,indicatorId:w.indicatorId,titleColor:w.titleColor,controls:w.controls};return N+=w.height+f,E})}else r=P-g,s&&(r=3);const y=[];y.push({left:"10%",right:"10%",top:g+"%",height:r+"%",containLabel:!1}),c.forEach(m=>{y.push({left:"10%",right:"10%",top:m.top+"%",height:m.height+"%",containLabel:!1})});const C=[0,...c.map((m,k)=>k+1)],x=[],M=c.length===0;x.push({type:"category",data:[],gridIndex:0,scale:!0,axisLine:{onZero:!1,show:!s,lineStyle:{color:"#334155"}},splitLine:{show:!s,lineStyle:{color:"#334155",opacity:.5}},axisLabel:{show:!s,color:"#94a3b8",fontFamily:i.fontFamily||"sans-serif"},axisTick:{show:!s},axisPointer:{label:{show:M,fontSize:11,backgroundColor:"#475569"}}}),c.forEach((m,k)=>{const z=k===c.length-1;x.push({type:"category",gridIndex:k+1,data:[],axisLabel:{show:!1},axisLine:{show:!m.isCollapsed,lineStyle:{color:"#334155"}},axisTick:{show:!1},splitLine:{show:!1},axisPointer:{label:{show:z,fontSize:11,backgroundColor:"#475569"}}})});const $=[];$.push({position:"right",scale:!0,gridIndex:0,splitLine:{show:!s,lineStyle:{color:"#334155",opacity:.5}},axisLine:{show:!s,lineStyle:{color:"#334155"}},axisLabel:{show:!s,color:"#94a3b8",fontFamily:i.fontFamily||"sans-serif"}}),c.forEach((m,k)=>{$.push({position:"right",scale:!0,gridIndex:k+1,splitLine:{show:!m.isCollapsed,lineStyle:{color:"#334155",opacity:.3}},axisLabel:{show:!m.isCollapsed,color:"#94a3b8",fontFamily:i.fontFamily||"sans-serif",fontSize:10},axisLine:{show:!m.isCollapsed,lineStyle:{color:"#334155"}}})});const Z=[];return d&&(Z.push({type:"inside",xAxisIndex:C,start:l,end:v}),b==="top"?Z.push({type:"slider",xAxisIndex:C,top:"1%",height:u+"%",start:l,end:v,borderColor:"#334155",textStyle:{color:"#cbd5e1"},brushSelect:!1}):Z.push({type:"slider",xAxisIndex:C,bottom:"1%",height:u+"%",start:l,end:v,borderColor:"#334155",textStyle:{color:"#cbd5e1"},brushSelect:!1})),{grid:y,xAxis:x,yAxis:$,dataZoom:Z,paneLayout:c,mainPaneHeight:r,mainPaneTop:g,pixelToPercent:o}}static calculateMaximized(e,t,i){return{grid:[],xAxis:[],yAxis:[],dataZoom:[],paneLayout:[],mainPaneHeight:0,mainPaneTop:0,pixelToPercent:0}}}const lt=new Map;function ft(a,e="#00da3c",t="64px"){if(typeof document>"u")return"";const i=`${a}-${e}-${t}`;if(lt.has(i))return lt.get(i);const s=document.createElement("canvas"),n=s.getContext("2d");if(s.width=32,s.height=32,n){n.font="bold "+t+" Arial",n.fillStyle=e,n.textAlign="center",n.textBaseline="middle",n.fillText(a,16,16);const o=s.toDataURL("image/png");return lt.set(i,o),o}return""}class ht{static buildCandlestickSeries(e,t,i){const s=t.upColor||"#00da3c",n=t.downColor||"#ec0000",o=e.map(h=>[h.open,h.close,h.low,h.high]);if(i&&i>o.length){const h=i-o.length;for(let p=0;p<h;p++)o.push(null)}return{type:"candlestick",name:t.title||"Market",data:o,itemStyle:{color:s,color0:n,borderColor:s,borderColor0:n},xAxisIndex:0,yAxisIndex:0,z:5}}static buildIndicatorSeries(e,t,i,s,n=0){const o=[];return e.forEach((h,p)=>{if(h.collapsed)return;let d=0,b=0;if(h.paneIndex>0){const u=i.findIndex(l=>l.index===h.paneIndex);u!==-1&&(d=u+1,b=u+1)}Object.keys(h.plots).forEach(u=>{const l=h.plots[u],v=`${p}::${u}`,g=new Array(s).fill(null),P=new Array(s).fill(null);switch(l.data.forEach(S=>{const f=t.get(S.time);if(f!==void 0){const r=S.options?.offset??l.options.offset??0,c=f+n+r;if(c>=0&&c<s){let y=S.value;const C=S.options?.color;(C===null||C==="na"||C==="NaN"||typeof C=="number"&&isNaN(C))&&(y=null),g[c]=y,P[c]=C||l.options.color}}}),l.options.style){case"histogram":case"columns":o.push({name:v,type:"bar",xAxisIndex:d,yAxisIndex:b,data:g.map((f,r)=>({value:f,itemStyle:P[r]?{color:P[r]}:void 0})),itemStyle:{color:l.options.color}});break;case"circles":case"cross":const S=g.map((f,r)=>{if(f===null)return null;const c=P[r]||l.options.color,y={value:[r,f],itemStyle:{color:c}};return l.options.style==="cross"?(y.symbol=`image://${ft("+",c,"24px")}`,y.symbolSize=16):(y.symbol="circle",y.symbolSize=6),y}).filter(f=>f!==null);o.push({name:v,type:"scatter",xAxisIndex:d,yAxisIndex:b,data:S});break;case"background":o.push({name:v,type:"custom",xAxisIndex:d,yAxisIndex:b,z:-10,renderItem:(f,r)=>{const c=r.value(0);if(isNaN(c))return;const y=r.coord([c,0]),C=r.size([1,0])[0],x=f.coordSys,M=y[0]-C/2,$=P[f.dataIndex],Z=r.value(1);if(!(!$||!Z))return{type:"rect",shape:{x:M,y:x.y,width:C,height:x.height},style:{fill:$,opacity:.3},silent:!0}},data:g.map((f,r)=>[r,f])});break;case"step":o.push({name:v,type:"custom",xAxisIndex:d,yAxisIndex:b,renderItem:(f,r)=>{const c=r.value(0),y=r.value(1);if(isNaN(y)||y===null)return;const C=r.coord([c,y]),x=r.size([1,0])[0];return{type:"line",shape:{x1:C[0]-x/2,y1:C[1],x2:C[0]+x/2,y2:C[1]},style:{stroke:P[f.dataIndex]||l.options.color,lineWidth:l.options.linewidth||1},silent:!0}},data:g.map((f,r)=>[r,f])});break;case"line":default:o.push({name:v,type:"custom",xAxisIndex:d,yAxisIndex:b,renderItem:(f,r)=>{const c=f.dataIndex;if(c===0)return;const y=r.value(1),C=r.value(2);if(y===null||isNaN(y)||C===null||isNaN(C))return;const x=r.coord([c-1,C]),M=r.coord([c,y]);return{type:"line",shape:{x1:x[0],y1:x[1],x2:M[0],y2:M[1]},style:{stroke:P[c]||l.options.color,lineWidth:l.options.linewidth||1},silent:!0}},data:g.map((f,r)=>[r,f,r>0?g[r-1]:null])});break}})}),o}}class yt{static build(e,t,i,s=!1,n=null){const o=[],h=e.pixelToPercent,p=e.mainPaneTop;if(!n||n==="main"){const d=10*h;if(o.push({type:"text",left:"8.5%",top:p+d+"%",z:10,style:{text:t.title||"Market",fill:t.titleColor||"#fff",font:`bold 16px ${t.fontFamily||"sans-serif"}`,textVerticalAlign:"top"}}),t.watermark!==!1){const u=e.mainPaneTop+e.mainPaneHeight;o.push({type:"text",right:"11%",top:u-3+"%",z:10,style:{text:"QFChart",fill:t.fontColor||"#cbd5e1",font:"bold 16px sans-serif",opacity:.1},cursor:"pointer",onclick:()=>{window.open("https://quantforge.org","_blank")}})}const b=[];if(t.controls?.collapse&&b.push({type:"group",children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>i("main","collapse")},{type:"text",style:{text:s?"+":"\u2212",fill:"#cbd5e1",font:`bold 14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]}),t.controls?.maximize){const u=n==="main",l=t.controls?.collapse?25:0;b.push({type:"group",x:l,children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>i("main","maximize")},{type:"text",style:{text:u?"\u2750":"\u25A1",fill:"#cbd5e1",font:`14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]})}if(t.controls?.fullscreen){let u=0;t.controls?.collapse&&(u+=25),t.controls?.maximize&&(u+=25),b.push({type:"group",x:u,children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>i("main","fullscreen")},{type:"text",style:{text:"\u26F6",fill:"#cbd5e1",font:`14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]})}b.length>0&&o.push({type:"group",right:"10.5%",top:p+"%",children:b})}return e.paneLayout.forEach(d=>{if(n&&d.indicatorId!==n)return;o.push({type:"text",left:"8.5%",top:d.top+10*h+"%",z:10,style:{text:d.indicatorId||"",fill:d.titleColor||"#fff",font:`bold 12px ${t.fontFamily||"sans-serif"}`,textVerticalAlign:"top"}});const b=[];if(d.controls?.collapse&&b.push({type:"group",children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>d.indicatorId&&i(d.indicatorId,"collapse")},{type:"text",style:{text:d.isCollapsed?"+":"\u2212",fill:"#cbd5e1",font:`bold 14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]}),d.controls?.maximize){const u=n===d.indicatorId,l=d.controls?.collapse?25:0;b.push({type:"group",x:l,children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>d.indicatorId&&i(d.indicatorId,"maximize")},{type:"text",style:{text:u?"\u2750":"\u25A1",fill:"#cbd5e1",font:`14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]})}b.length>0&&o.push({type:"group",right:"10.5%",top:d.top+"%",children:b})}),o}}class xt{static format(e,t){if(!e||e.length===0)return"";const i=t.title||"Market",s=t.upColor||"#00da3c",n=t.downColor||"#ec0000",o=t.fontFamily||"sans-serif",h=e[0].axisValue;let p=`<div style="font-weight: bold; margin-bottom: 5px; color: #cbd5e1; font-family: ${o};">${h}</div>`;const d=e.find(u=>u.seriesType==="candlestick"),b=e.filter(u=>u.seriesType!=="candlestick");if(d){const[u,l,v,g,P]=d.value,S=v>=l?s:n;p+=`
            <div style="margin-bottom: 8px; font-family: ${o};">
                <div style="display:flex; justify-content:space-between; color:${S}; font-weight:bold;">
                    <span>${i}</span>
                </div>
                <div style="display: grid; grid-template-columns: auto auto; gap: 2px 15px; font-size: 0.9em; color: #cbd5e1;">
                    <span>Open:</span> <span style="text-align: right; color: ${v>=l?s:n}">${l}</span>
                    <span>High:</span> <span style="text-align: right; color: ${s}">${P}</span>
                    <span>Low:</span> <span style="text-align: right; color: ${n}">${g}</span>
                    <span>Close:</span> <span style="text-align: right; color: ${v>=l?s:n}">${v}</span>
                </div>
            </div>
            `}if(b.length>0){p+='<div style="border-top: 1px solid #334155; margin: 5px 0; padding-top: 5px;"></div>';const u={};b.forEach(l=>{const v=l.seriesName.split("::"),g=v.length>1?v[0]:"Unknown",P=v.length>1?v[1]:l.seriesName;u[g]||(u[g]=[]),u[g].push({...l,displayName:P})}),Object.keys(u).forEach(l=>{p+=`
            <div style="margin-top: 8px; font-family: ${o};">
                <div style="font-weight:bold; color: #fff; margin-bottom: 2px;">${l}</div>
            `,u[l].forEach(v=>{let g=v.value;if(Array.isArray(g)&&(g=g[1]),g==null)return;const P=typeof g=="number"?g.toLocaleString(void 0,{maximumFractionDigits:4}):g;p+=`
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; padding-left: 8px;">
                    <div>${v.marker} <span style="color: #cbd5e1;">${v.displayName}</span></div>
                    <div style="font-size: 10px; color: #fff;padding-left:10px;">${P}</div>
                </div>`}),p+="</div>"})}return p}}var mt=Object.defineProperty,bt=(a,e,t)=>e in a?mt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,U=(a,e,t)=>(bt(a,typeof e!="symbol"?e+"":e,t),t);class vt{constructor(e,t){U(this,"plugins",new Map),U(this,"activePluginId",null),U(this,"context"),U(this,"toolbarContainer"),U(this,"tooltipElement",null),U(this,"hideTimeout",null),this.context=e,this.toolbarContainer=t,this.createTooltip(),this.renderToolbar()}createTooltip(){this.tooltipElement=document.createElement("div"),Object.assign(this.tooltipElement.style,{position:"fixed",display:"none",backgroundColor:"#1e293b",color:"#e2e8f0",padding:"6px 10px",borderRadius:"6px",fontSize:"13px",lineHeight:"1.4",fontWeight:"500",border:"1px solid #334155",zIndex:"9999",pointerEvents:"none",whiteSpace:"nowrap",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15)",fontFamily:this.context.getOptions().fontFamily||"sans-serif",transition:"opacity 0.15s ease-in-out, transform 0.15s ease-in-out",opacity:"0",transform:"translateX(-5px)"}),document.body.appendChild(this.tooltipElement)}destroy(){this.tooltipElement&&this.tooltipElement.parentNode&&this.tooltipElement.parentNode.removeChild(this.tooltipElement),this.tooltipElement=null}showTooltip(e,t){if(!this.tooltipElement)return;this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null);const i=e.getBoundingClientRect();this.tooltipElement.textContent=t,this.tooltipElement.style.display="block";const s=this.tooltipElement.getBoundingClientRect(),n=i.top+(i.height-s.height)/2,o=i.right+10;this.tooltipElement.style.top=`${n}px`,this.tooltipElement.style.left=`${o}px`,requestAnimationFrame(()=>{this.tooltipElement&&(this.tooltipElement.style.opacity="1",this.tooltipElement.style.transform="translateX(0)")})}hideTooltip(){this.tooltipElement&&(this.tooltipElement.style.opacity="0",this.tooltipElement.style.transform="translateX(-5px)",this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>{this.tooltipElement&&(this.tooltipElement.style.display="none"),this.hideTimeout=null},150))}register(e){if(this.plugins.has(e.id)){console.warn(`Plugin with id ${e.id} is already registered.`);return}this.plugins.set(e.id,e),e.init(this.context),this.addButton(e)}unregister(e){const t=this.plugins.get(e);t&&(this.activePluginId===e&&this.deactivatePlugin(),t.destroy?.(),this.plugins.delete(e),this.removeButton(e))}activatePlugin(e){if(this.activePluginId===e){this.deactivatePlugin();return}this.activePluginId&&this.deactivatePlugin();const t=this.plugins.get(e);t&&(this.activePluginId=e,this.setButtonActive(e,!0),t.activate?.())}deactivatePlugin(){this.activePluginId&&(this.plugins.get(this.activePluginId)?.deactivate?.(),this.setButtonActive(this.activePluginId,!1),this.activePluginId=null)}renderToolbar(){this.toolbarContainer.innerHTML="",this.toolbarContainer.style.display="flex",this.toolbarContainer.style.flexDirection="column",this.toolbarContainer.style.width="40px",this.toolbarContainer.style.backgroundColor=this.context.getOptions().backgroundColor||"#1e293b",this.toolbarContainer.style.borderRight="1px solid #334155",this.toolbarContainer.style.padding="5px",this.toolbarContainer.style.boxSizing="border-box",this.toolbarContainer.style.gap="5px",this.toolbarContainer.style.flexShrink="0"}addButton(e){const t=document.createElement("button");t.id=`qfchart-plugin-btn-${e.id}`,t.style.width="30px",t.style.height="30px",t.style.padding="4px",t.style.border="1px solid transparent",t.style.borderRadius="4px",t.style.backgroundColor="transparent",t.style.cursor="pointer",t.style.color=this.context.getOptions().fontColor||"#cbd5e1",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",e.icon?t.innerHTML=e.icon:t.innerText=(e.name||e.id).substring(0,2).toUpperCase(),t.addEventListener("mouseenter",()=>{this.activePluginId!==e.id&&(t.style.backgroundColor="rgba(255, 255, 255, 0.1)"),this.showTooltip(t,e.name||e.id)}),t.addEventListener("mouseleave",()=>{this.activePluginId!==e.id&&(t.style.backgroundColor="transparent"),this.hideTooltip()}),t.onclick=()=>this.activatePlugin(e.id),this.toolbarContainer.appendChild(t)}removeButton(e){const t=this.toolbarContainer.querySelector(`#qfchart-plugin-btn-${e}`);t&&t.remove()}setButtonActive(e,t){const i=this.toolbarContainer.querySelector(`#qfchart-plugin-btn-${e}`);i&&(t?(i.style.backgroundColor="#2563eb",i.style.color="#ffffff"):(i.style.backgroundColor="transparent",i.style.color=this.context.getOptions().fontColor||"#cbd5e1"))}}var wt=Object.defineProperty,Ct=(a,e,t)=>e in a?wt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,A=(a,e,t)=>(Ct(a,typeof e!="symbol"?e+"":e,t),t);class It{constructor(e){A(this,"context"),A(this,"isEditing",!1),A(this,"currentDrawing",null),A(this,"editingPointIndex",null),A(this,"zr"),A(this,"editGroup",null),A(this,"editLine",null),A(this,"editStartPoint",null),A(this,"editEndPoint",null),A(this,"isMovingShape",!1),A(this,"dragStart",null),A(this,"initialPixelPoints",[]),A(this,"onDrawingMouseDown",t=>{if(this.isEditing)return;const i=this.context.getDrawing(t.id);i&&(this.isEditing=!0,this.isMovingShape=!0,this.currentDrawing=JSON.parse(JSON.stringify(i)),this.dragStart={x:t.x,y:t.y},this.initialPixelPoints=i.points.map(s=>{const n=this.context.coordinateConversion.dataToPixel(s);return n?{x:n.x,y:n.y}:{x:0,y:0}}),this.context.lockChart(),this.createEditGraphic(),this.zr.on("mousemove",this.onMouseMove),this.zr.on("mouseup",this.onMouseUp))}),A(this,"onPointMouseDown",t=>{if(this.isEditing)return;const i=this.context.getDrawing(t.id);i&&(this.isEditing=!0,this.currentDrawing=JSON.parse(JSON.stringify(i)),this.editingPointIndex=t.pointIndex,this.context.lockChart(),this.createEditGraphic(),this.zr.on("mousemove",this.onMouseMove),this.zr.on("mouseup",this.onMouseUp))}),A(this,"onMouseMove",t=>{if(!this.isEditing||!this.currentDrawing)return;const i=t.offsetX,s=t.offsetY;if(this.isMovingShape&&this.dragStart){const n=i-this.dragStart.x,o=s-this.dragStart.y,h={x:this.initialPixelPoints[0].x+n,y:this.initialPixelPoints[0].y+o},p={x:this.initialPixelPoints[1].x+n,y:this.initialPixelPoints[1].y+o};this.editLine.setShape({x1:h.x,y1:h.y,x2:p.x,y2:p.y}),this.editStartPoint.setShape({cx:h.x,cy:h.y}),this.editEndPoint.setShape({cx:p.x,cy:p.y})}else this.editingPointIndex!==null&&(this.editingPointIndex===0?(this.editLine.setShape({x1:i,y1:s}),this.editStartPoint.setShape({cx:i,cy:s})):(this.editLine.setShape({x2:i,y2:s}),this.editEndPoint.setShape({cx:i,cy:s})))}),A(this,"onMouseUp",t=>{this.isEditing&&this.finishEditing(t.offsetX,t.offsetY)}),this.context=e,this.zr=this.context.getChart().getZr(),this.bindEvents()}bindEvents(){this.context.events.on("drawing:point:mousedown",this.onPointMouseDown),this.context.events.on("drawing:mousedown",this.onDrawingMouseDown)}createEditGraphic(){if(!this.currentDrawing)return;this.editGroup=new D.graphic.Group;const e=this.currentDrawing.points[0],t=this.currentDrawing.points[1],i=this.context.coordinateConversion.dataToPixel(e),s=this.context.coordinateConversion.dataToPixel(t);!i||!s||(this.editLine=new D.graphic.Line({shape:{x1:i.x,y1:i.y,x2:s.x,y2:s.y},style:{stroke:this.currentDrawing.style?.color||"#3b82f6",lineWidth:this.currentDrawing.style?.lineWidth||2,lineDash:[4,4]},silent:!0}),this.editStartPoint=new D.graphic.Circle({shape:{cx:i.x,cy:i.y,r:5},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:2},z:1e3}),this.editEndPoint=new D.graphic.Circle({shape:{cx:s.x,cy:s.y,r:5},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:2},z:1e3}),this.editGroup.add(this.editLine),this.editGroup.add(this.editStartPoint),this.editGroup.add(this.editEndPoint),this.zr.add(this.editGroup))}finishEditing(e,t){if(this.currentDrawing){if(this.isMovingShape&&this.dragStart){const i=e-this.dragStart.x,s=t-this.dragStart.y,n=this.initialPixelPoints.map((o,h)=>{const p=o.x+i,d=o.y+s;return this.context.coordinateConversion.pixelToData({x:p,y:d})});n.every(o=>o!==null)&&n[0]&&n[1]&&(this.currentDrawing.points[0]=n[0],this.currentDrawing.points[1]=n[1],n[0].paneIndex!==void 0&&(this.currentDrawing.paneIndex=n[0].paneIndex),this.context.updateDrawing(this.currentDrawing))}else if(this.editingPointIndex!==null){const i=this.context.coordinateConversion.pixelToData({x:e,y:t});i&&(this.currentDrawing.points[this.editingPointIndex]=i,this.editingPointIndex===0&&i.paneIndex!==void 0&&(this.currentDrawing.paneIndex=i.paneIndex),this.context.updateDrawing(this.currentDrawing))}this.isEditing=!1,this.isMovingShape=!1,this.dragStart=null,this.initialPixelPoints=[],this.currentDrawing=null,this.editingPointIndex=null,this.editGroup&&(this.zr.remove(this.editGroup),this.editGroup=null),this.zr.off("mousemove",this.onMouseMove),this.zr.off("mouseup",this.onMouseUp),this.context.unlockChart()}}}var kt=Object.defineProperty,Pt=(a,e,t)=>e in a?kt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,St=(a,e,t)=>(Pt(a,typeof e!="symbol"?e+"":e,t),t);class Dt{constructor(){St(this,"handlers",new Map)}on(e,t){this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t)}off(e,t){const i=this.handlers.get(e);i&&i.delete(t)}emit(e,t){const i=this.handlers.get(e);i&&i.forEach(s=>{try{s(t)}catch(n){console.error(`Error in EventBus handler for ${e}:`,n)}})}clear(){this.handlers.clear()}}var Et=Object.defineProperty,Mt=(a,e,t)=>e in a?Et(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,I=(a,e,t)=>(Mt(a,typeof e!="symbol"?e+"":e,t),t);class zt{constructor(e,t={}){I(this,"chart"),I(this,"options"),I(this,"marketData",[]),I(this,"indicators",new Map),I(this,"timeToIndex",new Map),I(this,"pluginManager"),I(this,"drawingEditor"),I(this,"events",new Dt),I(this,"isMainCollapsed",!1),I(this,"maximizedPaneId",null),I(this,"selectedDrawingId",null),I(this,"drawings",[]),I(this,"coordinateConversion",{pixelToData:n=>{const o=this.chart.getOption();if(!o||!o.grid)return null;const h=o.grid.length;for(let p=0;p<h;p++)if(this.chart.containPixel({gridIndex:p},[n.x,n.y])){this.chart.convertFromPixel({seriesIndex:p},[n.x,n.y]);const d=this.chart.convertFromPixel({gridIndex:p},[n.x,n.y]);if(d)return{timeIndex:Math.round(d[0]),value:d[1],paneIndex:p}}return null},dataToPixel:n=>{const o=n.paneIndex||0,h=this.chart.convertToPixel({gridIndex:o},[n.timeIndex,n.value]);return h?{x:h[0],y:h[1]}:null}}),I(this,"upColor","#00da3c"),I(this,"downColor","#ec0000"),I(this,"defaultPadding",0),I(this,"padding"),I(this,"dataIndexOffset",0),I(this,"rootContainer"),I(this,"layoutContainer"),I(this,"toolbarContainer"),I(this,"leftSidebar"),I(this,"rightSidebar"),I(this,"chartContainer"),I(this,"onKeyDown",n=>{(n.key==="Delete"||n.key==="Backspace")&&this.selectedDrawingId&&(this.removeDrawing(this.selectedDrawingId),this.selectedDrawingId=null,this.render())}),I(this,"onFullscreenChange",()=>{this.render()}),I(this,"isLocked",!1),I(this,"lockedState",null),this.rootContainer=e,this.options={title:"Market",height:"600px",backgroundColor:"#1e293b",upColor:"#00da3c",downColor:"#ec0000",fontColor:"#cbd5e1",fontFamily:"sans-serif",padding:.01,dataZoom:{visible:!0,position:"top",height:6},layout:{mainPaneHeight:"50%",gap:13},watermark:!0,...t},this.options.upColor&&(this.upColor=this.options.upColor),this.options.downColor&&(this.downColor=this.options.downColor),this.padding=this.options.padding!==void 0?this.options.padding:this.defaultPadding,this.options.height&&(typeof this.options.height=="number"?this.rootContainer.style.height=`${this.options.height}px`:this.rootContainer.style.height=this.options.height),this.rootContainer.innerHTML="",this.layoutContainer=document.createElement("div"),this.layoutContainer.style.display="flex",this.layoutContainer.style.width="100%",this.layoutContainer.style.height="100%",this.layoutContainer.style.overflow="hidden",this.rootContainer.appendChild(this.layoutContainer),this.leftSidebar=document.createElement("div"),this.leftSidebar.style.display="none",this.leftSidebar.style.width="250px",this.leftSidebar.style.flexShrink="0",this.leftSidebar.style.overflowY="auto",this.leftSidebar.style.backgroundColor=this.options.backgroundColor||"#1e293b",this.leftSidebar.style.borderRight="1px solid #334155",this.leftSidebar.style.padding="10px",this.leftSidebar.style.boxSizing="border-box",this.leftSidebar.style.color="#cbd5e1",this.leftSidebar.style.fontSize="12px",this.leftSidebar.style.fontFamily=this.options.fontFamily||"sans-serif",this.layoutContainer.appendChild(this.leftSidebar),this.toolbarContainer=document.createElement("div"),this.layoutContainer.appendChild(this.toolbarContainer),this.chartContainer=document.createElement("div"),this.chartContainer.style.flexGrow="1",this.chartContainer.style.height="100%",this.chartContainer.style.overflow="hidden",this.layoutContainer.appendChild(this.chartContainer),this.rightSidebar=document.createElement("div"),this.rightSidebar.style.display="none",this.rightSidebar.style.width="250px",this.rightSidebar.style.flexShrink="0",this.rightSidebar.style.overflowY="auto",this.rightSidebar.style.backgroundColor=this.options.backgroundColor||"#1e293b",this.rightSidebar.style.borderLeft="1px solid #334155",this.rightSidebar.style.padding="10px",this.rightSidebar.style.boxSizing="border-box",this.rightSidebar.style.color="#cbd5e1",this.rightSidebar.style.fontSize="12px",this.rightSidebar.style.fontFamily=this.options.fontFamily||"sans-serif",this.layoutContainer.appendChild(this.rightSidebar),this.chart=D.init(this.chartContainer),this.pluginManager=new vt(this,this.toolbarContainer),this.drawingEditor=new It(this),this.chart.on("dataZoom",n=>this.events.emit("chart:dataZoom",n)),this.chart.on("finished",n=>this.events.emit("chart:updated",n)),this.chart.getZr().on("mousedown",n=>this.events.emit("mouse:down",n)),this.chart.getZr().on("mousemove",n=>this.events.emit("mouse:move",n)),this.chart.getZr().on("mouseup",n=>this.events.emit("mouse:up",n)),this.chart.getZr().on("click",n=>this.events.emit("mouse:click",n));const i=this.chart.getZr(),s=i.setCursorStyle;i.setCursorStyle=function(n){n==="grab"&&(n="crosshair"),s.call(this,n)},this.bindDrawingEvents(),window.addEventListener("resize",this.resize.bind(this)),document.addEventListener("fullscreenchange",this.onFullscreenChange),document.addEventListener("keydown",this.onKeyDown)}bindDrawingEvents(){let e=null;const t=i=>{if(!i||i.componentType!=="series"||!i.seriesName?.startsWith("drawings"))return null;i.seriesIndex;const s=i.seriesName.match(/drawings-pane-(\d+)/);if(!s)return null;const n=parseInt(s[1]),o=this.drawings.filter(p=>(p.paneIndex||0)===n)[i.dataIndex];if(!o)return null;const h=i.event?.target?.name;return{drawing:o,targetName:h,paneIdx:n}};this.chart.on("mouseover",i=>{const s=t(i);if(!s)return;const n=i.event?.target?.parent;if(n){const o=s.drawing.id===this.selectedDrawingId;e&&(clearTimeout(e),e=null),o||n.children().forEach(h=>{h.name&&h.name.startsWith("point")&&h.attr("style",{opacity:1})})}if(s.targetName==="line")this.events.emit("drawing:hover",{id:s.drawing.id,type:s.drawing.type}),this.chart.getZr().setCursorStyle("move");else if(s.targetName?.startsWith("point")){const o=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:hover",{id:s.drawing.id,pointIndex:o}),this.chart.getZr().setCursorStyle("pointer")}}),this.chart.on("mouseout",i=>{const s=t(i);if(!s)return;const n=i.event?.target?.parent;if(s.drawing.id!==this.selectedDrawingId){if(e=setTimeout(()=>{if(n){if(this.selectedDrawingId===s.drawing.id)return;n.children().forEach(o=>{o.name&&o.name.startsWith("point")&&o.attr("style",{opacity:0})})}},50),s.targetName==="line")this.events.emit("drawing:mouseout",{id:s.drawing.id});else if(s.targetName?.startsWith("point")){const o=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:mouseout",{id:s.drawing.id,pointIndex:o})}this.chart.getZr().setCursorStyle("default")}}),this.chart.on("mousedown",i=>{const s=t(i);if(!s)return;const n=i.event?.event||i.event,o=n?.offsetX,h=n?.offsetY;if(s.targetName==="line")this.events.emit("drawing:mousedown",{id:s.drawing.id,x:o,y:h});else if(s.targetName?.startsWith("point")){const p=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:mousedown",{id:s.drawing.id,pointIndex:p,x:o,y:h})}}),this.chart.on("click",i=>{const s=t(i);if(s){if(this.selectedDrawingId!==s.drawing.id&&(this.selectedDrawingId=s.drawing.id,this.events.emit("drawing:selected",{id:s.drawing.id}),this.render()),s.targetName==="line")this.events.emit("drawing:click",{id:s.drawing.id});else if(s.targetName?.startsWith("point")){const n=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:click",{id:s.drawing.id,pointIndex:n})}}}),this.chart.getZr().on("click",i=>{i.target||this.selectedDrawingId&&(this.events.emit("drawing:deselected",{id:this.selectedDrawingId}),this.selectedDrawingId=null,this.render())})}getChart(){return this.chart}getMarketData(){return this.marketData}getTimeToIndex(){return this.timeToIndex}getOptions(){return this.options}disableTools(){this.pluginManager.deactivatePlugin()}registerPlugin(e){this.pluginManager.register(e)}addDrawing(e){this.drawings.push(e),this.render()}removeDrawing(e){const t=this.drawings.findIndex(i=>i.id===e);if(t!==-1){const i=this.drawings[t];this.drawings.splice(t,1),this.events.emit("drawing:deleted",{id:i.id}),this.render()}}getDrawing(e){return this.drawings.find(t=>t.id===e)}updateDrawing(e){const t=this.drawings.findIndex(i=>i.id===e.id);t!==-1&&(this.drawings[t]=e,this.render())}lockChart(){if(this.isLocked)return;this.isLocked=!0;const e=this.chart.getOption();this.chart.setOption({dataZoom:e.dataZoom.map(t=>({...t,disabled:!0})),tooltip:{show:!1}})}unlockChart(){if(!this.isLocked)return;this.isLocked=!1;const e=this.chart.getOption();(this.options.dataZoom||{}).visible,e.dataZoom&&this.chart.setOption({dataZoom:e.dataZoom.map(t=>({...t,disabled:!1})),tooltip:{show:!0}})}setZoom(e,t){this.chart.dispatchAction({type:"dataZoom",start:e,end:t})}setMarketData(e){this.marketData=e,this.rebuildTimeIndex(),this.render()}updateData(e){if(e.length===0)return;const t=new Map;this.marketData.forEach(l=>{t.set(l.time,l)}),e.forEach(l=>{t.has(l.time),t.set(l.time,l)}),this.marketData=Array.from(t.values()).sort((l,v)=>l.time-v.time),this.rebuildTimeIndex();const i=this.dataIndexOffset,s=this.marketData.map(l=>[l.open,l.close,l.low,l.high]),n={value:[NaN,NaN,NaN,NaN],itemStyle:{opacity:0}},o=[...Array(i).fill(n),...s,...Array(i).fill(n)],h=[...Array(i).fill(""),...this.marketData.map(l=>new Date(l.time).toLocaleString()),...Array(i).fill("")],p=this.chart.getOption(),d=ct.calculate(this.chart.getHeight(),this.indicators,this.options,this.isMainCollapsed,this.maximizedPaneId),b=ht.buildIndicatorSeries(this.indicators,this.timeToIndex,d.paneLayout,h.length,i),u={xAxis:p.xAxis.map((l,v)=>({data:h})),series:[{data:o},...b.map(l=>({data:l.data}))]};this.chart.setOption(u,{notMerge:!1})}addIndicator(e,t,i={isOverlay:!1}){const s=i.isOverlay??!1;let n=0;if(!s){let h=0;this.indicators.forEach(p=>{p.paneIndex>h&&(h=p.paneIndex)}),n=h+1}const o=new gt(e,t,n,{height:i.height,collapsed:!1,titleColor:i.titleColor,controls:i.controls});return this.indicators.set(e,o),this.render(),o}setIndicator(e,t,i=!1){this.addIndicator(e,{[e]:t},{isOverlay:i})}removeIndicator(e){this.indicators.delete(e),this.render()}toggleIndicator(e,t="collapse"){if(t==="fullscreen"){document.fullscreenElement?document.exitFullscreen():this.rootContainer.requestFullscreen();return}if(t==="maximize"){this.maximizedPaneId===e?this.maximizedPaneId=null:this.maximizedPaneId=e,this.render();return}if(e==="main"){this.isMainCollapsed=!this.isMainCollapsed,this.render();return}const i=this.indicators.get(e);i&&(i.toggleCollapse(),this.render())}resize(){this.chart.resize()}destroy(){window.removeEventListener("resize",this.resize.bind(this)),document.removeEventListener("fullscreenchange",this.onFullscreenChange),document.removeEventListener("keydown",this.onKeyDown),this.pluginManager.deactivatePlugin(),this.pluginManager.destroy(),this.chart.dispose()}rebuildTimeIndex(){this.timeToIndex.clear(),this.marketData.forEach((i,s)=>{this.timeToIndex.set(i.time,s)});const e=this.marketData.length,t=Math.ceil(e*this.padding);this.dataIndexOffset=t}render(){if(this.marketData.length===0)return;let e=null;try{const r=this.chart.getOption();if(r&&r.dataZoom&&r.dataZoom.length>0){const c=r.dataZoom.find(y=>y.type==="slider"||y.type==="inside");c&&(e={start:c.start,end:c.end})}}catch{}const t=this.options.databox?.position,i=this.leftSidebar.style.display,s=this.rightSidebar.style.display,n=t==="left"?"block":"none",o=t==="right"?"block":"none";(i!==n||s!==o)&&(this.leftSidebar.style.display=n,this.rightSidebar.style.display=o,this.chart.resize());const h=this.dataIndexOffset,p=[...Array(h).fill(""),...this.marketData.map(r=>new Date(r.time).toLocaleString()),...Array(h).fill("")],d=ct.calculate(this.chart.getHeight(),this.indicators,this.options,this.isMainCollapsed,this.maximizedPaneId);e&&d.dataZoom&&d.dataZoom.forEach(r=>{r.start=e.start,r.end=e.end}),d.xAxis.forEach(r=>{r.data=p,r.boundaryGap=!1});const b=ht.buildCandlestickSeries(this.marketData,this.options),u={value:[NaN,NaN,NaN,NaN],itemStyle:{opacity:0}};b.data=[...Array(h).fill(u),...b.data,...Array(h).fill(u)];const l=ht.buildIndicatorSeries(this.indicators,this.timeToIndex,d.paneLayout,p.length,h),v=yt.build(d,this.options,this.toggleIndicator.bind(this),this.isMainCollapsed,this.maximizedPaneId),g=new Map;this.drawings.forEach(r=>{const c=r.paneIndex||0;g.has(c)||g.set(c,[]),g.get(c).push(r)});const P=[];g.forEach((r,c)=>{P.push({type:"custom",name:`drawings-pane-${c}`,xAxisIndex:c,yAxisIndex:c,clip:!0,renderItem:(y,C)=>{const x=r[y.dataIndex];if(!x)return;const M=x.points[0],$=x.points[1];if(!M||!$)return;const Z=C.coord([M.timeIndex,M.value]),m=C.coord([$.timeIndex,$.value]),k=x.id===this.selectedDrawingId;if(x.type==="line")return{type:"group",children:[{type:"line",name:"line",shape:{x1:Z[0],y1:Z[1],x2:m[0],y2:m[1]},style:{stroke:x.style?.color||"#3b82f6",lineWidth:x.style?.lineWidth||2}},{type:"circle",name:"point-start",shape:{cx:Z[0],cy:Z[1],r:4},style:{fill:"#fff",stroke:x.style?.color||"#3b82f6",lineWidth:1,opacity:k?1:0}},{type:"circle",name:"point-end",shape:{cx:m[0],cy:m[1],r:4},style:{fill:"#fff",stroke:x.style?.color||"#3b82f6",lineWidth:1,opacity:k?1:0}}]};if(x.type==="fibonacci"){const z=Z[0],O=Z[1],N=m[0],w=m[1],E=Math.min(z,N),Y=Math.max(z,N),F=Y-E,T=w-O,W=[0,.236,.382,.5,.618,.786,1],B=["#787b86","#f44336","#ff9800","#4caf50","#2196f3","#00bcd4","#787b86"],V=[];V.push({type:"line",name:"line",shape:{x1:z,y1:O,x2:N,y2:w},style:{stroke:"#999",lineWidth:1,lineDash:[4,4]}}),V.push({type:"circle",name:"point-start",shape:{cx:z,cy:O,r:4},style:{fill:"#fff",stroke:x.style?.color||"#3b82f6",lineWidth:1,opacity:k?1:0},z:100}),V.push({type:"circle",name:"point-end",shape:{cx:N,cy:w,r:4},style:{fill:"#fff",stroke:x.style?.color||"#3b82f6",lineWidth:1,opacity:k?1:0},z:100}),W.forEach((j,X)=>{const H=w-T*j,J=B[X%B.length];V.push({type:"line",name:"fib-line",shape:{x1:E,y1:H,x2:Y,y2:H},style:{stroke:J,lineWidth:1},silent:!0});const it=x.points[0].value,K=x.points[1].value,st=K-it,nt=K-st*j;if(V.push({type:"text",style:{text:`${j} (${nt.toFixed(2)})`,x:E+5,y:H-10,fill:J,fontSize:10},silent:!0}),X<W.length-1){const ot=W[X+1],Q=w-T*ot,at=Math.abs(Q-H),rt=Math.min(H,Q);V.push({type:"rect",shape:{x:E,y:rt,width:F,height:at},style:{fill:B[(X+1)%B.length],opacity:.1},silent:!0})}});const dt=[],et=[];return W.forEach((j,X)=>{const H=w-T*j,J=B[X%B.length];et.push({type:"line",shape:{x1:E,y1:H,x2:Y,y2:H},style:{stroke:J,lineWidth:1},silent:!0});const it=x.points[0].value,K=x.points[1].value,st=K-it,nt=K-st*j;if(et.push({type:"text",style:{text:`${j} (${nt.toFixed(2)})`,x:E+5,y:H-10,fill:J,fontSize:10},silent:!0}),X<W.length-1){const ot=W[X+1],Q=w-T*ot,at=Math.abs(Q-H),rt=Math.min(H,Q);dt.push({type:"rect",name:"line",shape:{x:E,y:rt,width:F,height:at},style:{fill:B[(X+1)%B.length],opacity:.1}})}}),{type:"group",children:[...dt,...et,{type:"line",name:"line",shape:{x1:z,y1:O,x2:N,y2:w},style:{stroke:"#999",lineWidth:1,lineDash:[4,4]}},{type:"circle",name:"point-start",shape:{cx:z,cy:O,r:4},style:{fill:"#fff",stroke:x.style?.color||"#3b82f6",lineWidth:1,opacity:k?1:0},z:100},{type:"circle",name:"point-end",shape:{cx:N,cy:w,r:4},style:{fill:"#fff",stroke:x.style?.color||"#3b82f6",lineWidth:1,opacity:k?1:0},z:100}]}}},data:r.map(y=>[y.points[0].timeIndex,y.points[0].value,y.points[1].timeIndex,y.points[1].value]),z:100,silent:!1})});const S=r=>{const c=xt.format(r,this.options),y=this.options.databox?.position;return y==="left"?(this.leftSidebar.innerHTML=c,""):y==="right"?(this.rightSidebar.innerHTML=c,""):this.options.databox?`<div style="min-width: 200px;">${c}</div>`:""},f={backgroundColor:this.options.backgroundColor,animation:!1,legend:{show:!1},tooltip:{show:!0,showContent:!!this.options.databox,trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#475569"}},backgroundColor:"rgba(30, 41, 59, 0.9)",borderWidth:1,borderColor:"#334155",padding:10,textStyle:{color:"#fff",fontFamily:this.options.fontFamily||"sans-serif"},formatter:S,extraCssText:t!=="floating"&&t!==void 0?"display: none !important;":void 0,position:(r,c,y,C,x)=>{if(this.options.databox?.position==="floating"){const M={top:10};return M[["left","right"][+(r[0]<x.viewSize[0]/2)]]=30,M}return null}},axisPointer:{link:{xAxisIndex:"all"},label:{backgroundColor:"#475569"}},graphic:v,grid:d.grid,xAxis:d.xAxis,yAxis:d.yAxis,dataZoom:d.dataZoom,series:[b,...l,...P]};this.chart.setOption(f,!0)}}var Tt=Object.defineProperty,Lt=(a,e,t)=>e in a?Tt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,_=(a,e,t)=>(Lt(a,typeof e!="symbol"?e+"":e,t),t);class tt{constructor(e){_(this,"id"),_(this,"name"),_(this,"icon"),_(this,"context"),_(this,"eventListeners",[]),this.id=e.id,this.name=e.name,this.icon=e.icon}init(e){this.context=e,this.onInit()}onInit(){}activate(){this.onActivate(),this.context.events.emit("plugin:activated",this.id)}onActivate(){}deactivate(){this.onDeactivate(),this.context.events.emit("plugin:deactivated",this.id)}onDeactivate(){}destroy(){this.removeAllListeners(),this.onDestroy()}onDestroy(){}on(e,t){this.context.events.on(e,t),this.eventListeners.push({event:e,handler:t})}off(e,t){this.context.events.off(e,t),this.eventListeners=this.eventListeners.filter(i=>i.event!==e||i.handler!==t)}removeAllListeners(){this.eventListeners.forEach(({event:e,handler:t})=>{this.context.events.off(e,t)}),this.eventListeners=[]}get chart(){return this.context.getChart()}get marketData(){return this.context.getMarketData()}}var At=Object.defineProperty,Zt=(a,e,t)=>e in a?At(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,L=(a,e,t)=>(Zt(a,typeof e!="symbol"?e+"":e,t),t);class Gt extends tt{constructor(e){super({id:"measure",name:e?.name||"Measure",icon:e?.icon||'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M160-240q-33 0-56.5-23.5T80-320v-320q0-33 23.5-56.5T160-720h640q33 0 56.5 23.5T880-640v320q0 33-23.5 56.5T800-240H160Zm0-80h640v-320H680v160h-80v-160h-80v160h-80v-160h-80v160h-80v-160H160v320Zm120-160h80-80Zm160 0h80-80Zm160 0h80-80Zm-120 0Z"/></svg>'}),L(this,"zr"),L(this,"state","idle"),L(this,"startPoint",null),L(this,"endPoint",null),L(this,"group",null),L(this,"rect",null),L(this,"labelRect",null),L(this,"labelText",null),L(this,"lineV",null),L(this,"lineH",null),L(this,"arrowStart",null),L(this,"arrowEnd",null),L(this,"onMouseDown",()=>{this.state==="finished"&&this.removeGraphic()}),L(this,"onChartInteraction",()=>{this.group&&this.removeGraphic()}),L(this,"onClick",t=>{this.state==="idle"?(this.state="drawing",this.startPoint=[t.offsetX,t.offsetY],this.endPoint=[t.offsetX,t.offsetY],this.initGraphic(),this.updateGraphic()):this.state==="drawing"&&(this.state="finished",this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic(),this.context.disableTools(),this.enableClearListeners())}),L(this,"clearHandlers",{}),L(this,"onMouseMove",t=>{this.state==="drawing"&&(this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic())})}onInit(){this.zr=this.chart.getZr()}onActivate(){this.state="idle",this.chart.getZr().setCursorStyle("crosshair"),this.zr.on("click",this.onClick),this.zr.on("mousemove",this.onMouseMove)}onDeactivate(){this.state="idle",this.chart.getZr().setCursorStyle("default"),this.zr.off("click",this.onClick),this.zr.off("mousemove",this.onMouseMove),this.disableClearListeners(),this.state==="drawing"&&this.removeGraphic()}onDestroy(){this.removeGraphic()}enableClearListeners(){const e=()=>{this.removeGraphic()};setTimeout(()=>{this.zr.on("click",e)},10),this.zr.on("mousedown",this.onMouseDown),this.context.events.on("chart:dataZoom",this.onChartInteraction),this.clearHandlers={click:e,mousedown:this.onMouseDown,dataZoom:this.onChartInteraction}}disableClearListeners(){this.clearHandlers.click&&this.zr.off("click",this.clearHandlers.click),this.clearHandlers.mousedown&&this.zr.off("mousedown",this.clearHandlers.mousedown),this.clearHandlers.dataZoom&&this.context.events.off("chart:dataZoom",this.clearHandlers.dataZoom),this.clearHandlers={}}initGraphic(){this.group||(this.group=new D.graphic.Group,this.rect=new D.graphic.Rect({shape:{x:0,y:0,width:0,height:0},style:{fill:"rgba(0,0,0,0)",stroke:"transparent",lineWidth:0},z:100}),this.lineV=new D.graphic.Line({shape:{x1:0,y1:0,x2:0,y2:0},style:{stroke:"#fff",lineWidth:1,lineDash:[4,4]},z:101}),this.lineH=new D.graphic.Line({shape:{x1:0,y1:0,x2:0,y2:0},style:{stroke:"#fff",lineWidth:1,lineDash:[4,4]},z:101}),this.arrowStart=new D.graphic.Polygon({shape:{points:[[0,0],[-5,10],[5,10]]},style:{fill:"#fff"},z:102}),this.arrowEnd=new D.graphic.Polygon({shape:{points:[[0,0],[-5,-10],[5,-10]]},style:{fill:"#fff"},z:102}),this.labelRect=new D.graphic.Rect({shape:{x:0,y:0,width:0,height:0,r:4},style:{fill:"transparent",stroke:"transparent",lineWidth:0,shadowBlur:5,shadowColor:"rgba(0,0,0,0.3)"},z:102}),this.labelText=new D.graphic.Text({style:{x:0,y:0,text:"",fill:"#fff",font:"12px sans-serif",align:"center",verticalAlign:"middle"},z:103}),this.group.add(this.rect),this.group.add(this.lineV),this.group.add(this.lineH),this.group.add(this.arrowStart),this.group.add(this.arrowEnd),this.group.add(this.labelRect),this.group.add(this.labelText),this.zr.add(this.group))}removeGraphic(){this.group&&(this.zr.remove(this.group),this.group=null,this.disableClearListeners())}updateGraphic(){if(!this.startPoint||!this.endPoint||!this.group)return;const[e,t]=this.startPoint,[i,s]=this.endPoint,n=this.context.coordinateConversion.pixelToData({x:e,y:t}),o=this.context.coordinateConversion.pixelToData({x:i,y:s});if(!n||!o)return;const h=Math.round(n.timeIndex),p=Math.round(o.timeIndex),d=n.value,b=o.value,u=p-h,l=b-d,v=l/d*100,g=l>=0,P=g?"rgba(33, 150, 243, 0.2)":"rgba(236, 0, 0, 0.2)",S=g?"#2196F3":"#ec0000";this.rect.setShape({x:Math.min(e,i),y:Math.min(t,s),width:Math.abs(i-e),height:Math.abs(s-t)}),this.rect.setStyle({fill:P});const f=(e+i)/2,r=(t+s)/2;this.lineV.setShape({x1:f,y1:t,x2:f,y2:s}),this.lineV.setStyle({stroke:S}),this.lineH.setShape({x1:e,y1:r,x2:i,y2:r}),this.lineH.setStyle({stroke:S});const c=Math.min(t,s),y=Math.max(t,s);this.arrowStart.setStyle({fill:"none"}),this.arrowEnd.setStyle({fill:"none"}),g?(this.arrowStart.setShape({points:[[f,c],[f-4,c+6],[f+4,c+6]]}),this.arrowStart.setStyle({fill:S})):(this.arrowEnd.setShape({points:[[f,y],[f-4,y-6],[f+4,y-6]]}),this.arrowEnd.setStyle({fill:S}));const C=[`${l.toFixed(2)} (${v.toFixed(2)}%)`,`${u} bars, ${(u*0).toFixed(0)}d`].join(`
`),x=140,M=40,$=Math.max(t,s),Z=Math.min(t,s);let m=(e+i)/2-x/2,k=$+10;const z=this.chart.getHeight();k+M>z&&(k=Z-M-10),this.labelRect.setShape({x:m,y:k,width:x,height:M}),this.labelRect.setStyle({fill:"#1e293b",stroke:S,lineWidth:1}),this.labelText.setStyle({x:m+x/2,y:k+M/2,text:C,fill:"#fff"})}}var $t=Object.defineProperty,Nt=(a,e,t)=>e in a?$t(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,G=(a,e,t)=>(Nt(a,typeof e!="symbol"?e+"":e,t),t);class Ft extends tt{constructor(e){super({id:"trend-line",name:e?.name||"Trend Line",icon:e?.icon||'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="22" x2="22" y2="2" /></svg>'}),G(this,"zr"),G(this,"state","idle"),G(this,"startPoint",null),G(this,"endPoint",null),G(this,"group",null),G(this,"line",null),G(this,"startCircle",null),G(this,"endCircle",null),G(this,"onMouseDown",()=>{}),G(this,"onChartInteraction",()=>{}),G(this,"onClick",t=>{if(this.state==="idle")this.state="drawing",this.startPoint=[t.offsetX,t.offsetY],this.endPoint=[t.offsetX,t.offsetY],this.initGraphic(),this.updateGraphic();else if(this.state==="drawing"){if(this.state="finished",this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic(),this.startPoint&&this.endPoint){const i=this.context.coordinateConversion.pixelToData({x:this.startPoint[0],y:this.startPoint[1]}),s=this.context.coordinateConversion.pixelToData({x:this.endPoint[0],y:this.endPoint[1]});if(i&&s){const n=i.paneIndex||0;this.context.addDrawing({id:`line-${Date.now()}`,type:"line",points:[i,s],paneIndex:n,style:{color:"#3b82f6",lineWidth:2}})}}this.removeGraphic(),this.context.disableTools()}}),G(this,"clearHandlers",{}),G(this,"onMouseMove",t=>{this.state==="drawing"&&(this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic())})}onInit(){this.zr=this.chart.getZr()}onActivate(){this.state="idle",this.chart.getZr().setCursorStyle("crosshair"),this.zr.on("click",this.onClick),this.zr.on("mousemove",this.onMouseMove)}onDeactivate(){this.state="idle",this.chart.getZr().setCursorStyle("default"),this.zr.off("click",this.onClick),this.zr.off("mousemove",this.onMouseMove),this.disableClearListeners(),this.state==="drawing"&&this.removeGraphic()}onDestroy(){this.removeGraphic()}saveDataCoordinates(){}updateGraphicFromData(){}enableClearListeners(){}disableClearListeners(){}initGraphic(){this.group||(this.group=new D.graphic.Group,this.line=new D.graphic.Line({shape:{x1:0,y1:0,x2:0,y2:0},style:{stroke:"#3b82f6",lineWidth:2},z:100}),this.startCircle=new D.graphic.Circle({shape:{cx:0,cy:0,r:4},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:1},z:101}),this.endCircle=new D.graphic.Circle({shape:{cx:0,cy:0,r:4},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:1},z:101}),this.group.add(this.line),this.group.add(this.startCircle),this.group.add(this.endCircle),this.zr.add(this.group))}removeGraphic(){this.group&&(this.zr.remove(this.group),this.group=null,this.disableClearListeners())}updateGraphic(){if(!this.startPoint||!this.endPoint||!this.group)return;const[e,t]=this.startPoint,[i,s]=this.endPoint;this.line.setShape({x1:e,y1:t,x2:i,y2:s}),this.startCircle.setShape({cx:e,cy:t}),this.endCircle.setShape({cx:i,cy:s})}}var Wt=Object.defineProperty,Ht=(a,e,t)=>e in a?Wt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,R=(a,e,t)=>(Ht(a,typeof e!="symbol"?e+"":e,t),t);class Ot extends tt{constructor(e={}){super({id:"fibonacci-tool",name:e.name||"Fibonacci Retracement",icon:e.icon||'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M120-80v-80h720v80H120Zm0-240v-80h720v80H120Zm0-240v-80h720v80H120Zm0-240v-80h720v80H120Z"/></svg>'}),R(this,"startPoint",null),R(this,"endPoint",null),R(this,"state","idle"),R(this,"graphicGroup",null),R(this,"levels",[0,.236,.382,.5,.618,.786,1]),R(this,"colors",["#787b86","#f44336","#ff9800","#4caf50","#2196f3","#00bcd4","#787b86"]),R(this,"onClick",t=>{this.state==="idle"?(this.state="drawing",this.startPoint=[t.offsetX,t.offsetY],this.endPoint=[t.offsetX,t.offsetY],this.initGraphic(),this.updateGraphic()):this.state==="drawing"&&(this.state="finished",this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic(),this.saveDrawing(),this.removeGraphic(),this.context.disableTools())}),R(this,"onMouseMove",t=>{this.state==="drawing"&&(this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic())})}onActivate(){this.state="idle",this.startPoint=null,this.endPoint=null,this.context.getChart().getZr().setCursorStyle("crosshair"),this.bindEvents()}onDeactivate(){this.state="idle",this.startPoint=null,this.endPoint=null,this.removeGraphic(),this.unbindEvents(),this.context.getChart().getZr().setCursorStyle("default")}bindEvents(){const e=this.context.getChart().getZr();e.on("click",this.onClick),e.on("mousemove",this.onMouseMove)}unbindEvents(){const e=this.context.getChart().getZr();e.off("click",this.onClick),e.off("mousemove",this.onMouseMove)}initGraphic(){this.graphicGroup=new D.graphic.Group,this.context.getChart().getZr().add(this.graphicGroup)}removeGraphic(){this.graphicGroup&&(this.context.getChart().getZr().remove(this.graphicGroup),this.graphicGroup=null)}updateGraphic(){if(!this.graphicGroup||!this.startPoint||!this.endPoint)return;this.graphicGroup.removeAll();const e=this.startPoint[0],t=this.startPoint[1],i=this.endPoint[0],s=this.endPoint[1],n=new D.graphic.Line({shape:{x1:e,y1:t,x2:i,y2:s},style:{stroke:"#999",lineWidth:1,lineDash:[4,4]},silent:!0});this.graphicGroup.add(n);const o=Math.min(e,i),h=Math.max(e,i),p=h-o,d=s-t;this.levels.forEach((b,u)=>{const l=s-d*b,v=this.colors[u%this.colors.length],g=new D.graphic.Line({shape:{x1:o,y1:l,x2:h,y2:l},style:{stroke:v,lineWidth:1},silent:!0});if(this.graphicGroup.add(g),u<this.levels.length-1){const P=this.levels[u+1],S=s-d*P,f=Math.abs(S-l),r=Math.min(l,S),c=new D.graphic.Rect({shape:{x:o,y:r,width:p,height:f},style:{fill:this.colors[(u+1)%this.colors.length],opacity:.1},silent:!0});this.graphicGroup.add(c)}})}saveDrawing(){if(!this.startPoint||!this.endPoint)return;const e=this.context.coordinateConversion.pixelToData({x:this.startPoint[0],y:this.startPoint[1]}),t=this.context.coordinateConversion.pixelToData({x:this.endPoint[0],y:this.endPoint[1]});if(e&&t){const i=e.paneIndex||0;this.context.addDrawing({id:`fib-${Date.now()}`,type:"fibonacci",points:[e,t],paneIndex:i,style:{color:"#3b82f6",lineWidth:1}})}}}export{tt as AbstractPlugin,Ot as FibonacciTool,Ft as LineTool,Gt as MeasureTool,zt as QFChart};
